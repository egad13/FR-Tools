<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>FR Hatchling Probability Calculator</title>
	<meta name="description" content="Flight Rising Breeding Probability Calculator">
	<meta name="author" content="Kaykao">

	<link rel="stylesheet" href="css/styles.css?v=0.2">
	<link rel="stylesheet" href="css/hatchcalc.css?v=0.2">
	
	<script type="text/javascript" src="js/fr_data.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/hatchcalc.js"></script>

</head>

<body>

<header>
	<h1>FR Hatchling Probability Calculator</h1>
</header>
	
<main>
	
	<form>
		<h2>Input</h2>
		
		<fieldset id="parent1">
			<legend>Parent 1</legend>
			
			<label for="p1-b">Breed:</label>
			<select class="breed" id="p1-b"></select>
			
			<span>Primary:</span>
			<label for="p1-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="p1-c1"></select>
			<label for="p1-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="p1-g1"></select>
			
			<span>Secondary:</span>
			<label for="p1-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="p1-c2"></select>
			<label for="p1-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="p1-g2"></select>
			
			<span>Tertiary:</span>
			<label for="p1-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="p1-c3"></select>
			<label for="p1-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="p1-g3"></select>
		</fieldset>
		
		<fieldset id="parent2">
			<legend>Parent 2</legend>
			
			<label for="p2-b">Breed:</label>
			<select class="breed" id="p2-b"></select>
			
			<span>Primary:</span>
			<label for="p2-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="p2-c1"></select>
			<label for="p2-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="p2-g1"></select>
			
			<span>Secondary:</span>
			<label for="p2-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="p2-c2"></select>
			<label for="p2-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="p2-g2"></select>
			
			<span>Tertiary:</span>
			<label for="p2-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="p2-c3"></select>
			<label for="p2-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="p2-g3"></select>
		</fieldset>

		<fieldset id="hatchling">
			<legend>Hatchling</legend>
			
			<label for="h-b">Breed:</label>
			<select class="breed" id="h-b">
				<option value="any" selected="selected">Any</option>
			</select>
			
			<label for="h-e">Eye Type:</label>
			<select id="h-e" class="eye">
				<option value="any" selected="selected">Any</option>
			</select>
			
			<label for="h-gen">Gender:</label>
			<select id="h-gen" class="gender">
				<option value="any" selected="selected">Any</option>
				<option value="m">Male</option>
				<option value="f">Female</option>
			</select>
			
			<span>Primary:</span>
			<label for="h-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="h-c1">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="h-g1">
				<option value="any" selected="selected">Any</option>
			</select>
			
			<span>Secondary:</span>
			<label for="h-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="h-c2">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="h-g2">
				<option value="any" selected="selected">Any</option>
			</select>
			
			<span>Tertiary:</span>
			<label for="h-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="h-c3">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="h-g3">
				<option value="any" selected="selected">Any</option>
			</select>
			
			<!-- TODO colour ranges
			<input type="radio" name="ranges" id="range-no" checked />
			<label>Specific Colours</label><br>
			<input type="radio" name="ranges" id="range-yes" />
			<label>Colour Ranges</label>
			 -->
			
		</fieldset>
		
		<button type="button" id="calc">Calculate Probability</button>
	</form>
	
	<section >
		<h2>Results</h2>
	
		<div id="results">
			<div id="placeholder">
				<p>Enter the info for the parents and the desired hatchling, then click Calculate!</p>
			</div>
		</div>
	</section>
	
</main>


<footer>
	<span><a href="https://github.com/egad13/FR-Hatchling-Probability">Source code</a></span>
	|
	<span>Last updated: <time datetime="2023-07-29">29 July 2023</time></span>
</footer>
	
	<!-- TODO add credits for where you got your dataaaaaaaa -->
	
	<script id="misc-functions">
		// Collects all the dropdown nodes for a dragon into one object for easy manipulation and access
		function collectDragonSelects(id){
			var res = {
				breed: Util.query(`#${id} .breed`),
				colours: {
					primary: Util.query(`#${id} .primary.colour`),
					secondary: Util.query(`#${id} .secondary.colour`),
					tertiary: Util.query(`#${id} .tertiary.colour`)
				},
				genes: {
					primary: Util.query(`#${id} .primary.gene`),
					secondary: Util.query(`#${id} .secondary.gene`),
					tertiary: Util.query(`#${id} .tertiary.gene`)
				}
			};
			if (id === "hatchling") {
				res.eye = Util.query("#hatchling .eye");
				res.gender = Util.query("#hatchling .gender");
			}
			return res;
		}
		
		// Turns a table of probabilities given by HatchCalc into rows for an HTML table
		function chanceTableToHtml(table) {
			var out = "";
			for (var i = 0; i < table.length; i++){
				if (table[i][1] >= 0.999){
					table[i][1] = "~100%";
				} else {
					table[i][1] = (table[i][1]*100).toFixed(2) + "%";
				}
				out += 
					`<tr>
						<td>${table[i][0]}</td>
						<td>${table[i][1]}</td>
					</tr>`;
			}
			return out;
		}
	</script>
	<script id="event-handlers">
		// Event handler for the "Calculate Probability" button
		function calcProbabilities(){
			//calculate probabilities
			const getVal = (x) => x.options[x.selectedIndex].value;
			const p = HatchCalc.hatchlingProbability(
				Util.mapObj(parent1, getVal),
				Util.mapObj(parent2, getVal),
				Util.mapObj(goal, getVal)
			);
			
			// display the results
			if (p.err.length > 0){
				resultElt.innerHTML = 
					`<div id="placeholder">
						<p>That hatchling is impossible with the given parents!</p>
						<ul>
							<li>${p.err.join("</li>\n<li>")}</li>
						</ul>
					</div>`;
			} else {
				resultElt.innerHTML =
					`<div id="overview">
						<p>This pair will produce a Goal hatchling ${(p.overall*100).toFixed(2)}% of the time, or 1 out of every ${(1/p.overall).toFixed(2)} eggs.</p>
					
						<p>Each nest will have an average of ${p.avg_nest_size.toFixed(2)} eggs. This means each nest has a ${(p.per_nest*100).toFixed(2)}% chance of producing a Goal hatchling, or 1 out of every ${(1/p.per_nest).toFixed(2)} nests.</p>
					</div>
					
					<table id="egg-table">
						<caption>Chance of hatching Goal within X eggs:</caption>
						<tr><th>Eggs</th><th>Chance</th></tr>
						${chanceTableToHtml(p.egg_table)}
					</table>
				
					<table id="nest-table">
						<caption>Chance of hatching Goal within X nests:</caption>
						<tr><th>Nests</th><th>Chance</th></tr>
						${chanceTableToHtml(p.nest_table)}
					</table>
				
					<table id="attrs-table">
						<caption>Chances of a hatchling with X matching the Goal:</caption>
						<tr><th>Attribute</th><th>Chance</th></tr>
						<tr><td>Breed</td><td>${(p.breed*100).toFixed(2)}%</td></tr>
						<tr><td>Eye type</td><td>${(p.eye*100).toFixed(2)}%</td></tr>
						<tr><td>Colours</td><td>${(p.colour*100).toFixed(2)}%</td></tr>
						<tr><td>Genes</td><td>${(p.gene*100).toFixed(2)}%</td></tr>
					</table>`;
			}
				
		}
	</script>
	<script id="window-onload">
		const calcBtn = Util.get("calc"),
			resultElt = Util.get("results"),
			colourDropdowns = Util.getClz("colour"),
			breedDropdowns = Util.getClz("breed"),
			geneDropdowns = Util.getClz("gene");
		
		const parent1 = collectDragonSelects("parent1"),
			parent2 = collectDragonSelects("parent2"),
			goal = collectDragonSelects("hatchling");
		
		// populate the eye dropdown
		for (var i = 0; i < FRdata.eyes.length; i++){
			const opt = Util.createElt("option", {value: i, text: FRdata.eyes[i].name});
			Util.get("h-e").add(opt);
		}
		
		// populate the breed dropdowns
		for (var elt of breedDropdowns) {
			const moderns = Util.createElt("optgroup", {label: "Modern"}),
				ancients = Util.createElt("optgroup", {label: "Ancient"});
			
			for (var i = 0; i < FRdata.breeds.length; i++) {
				const opt = Util.createElt("option", {value: i, text: FRdata.breeds[i].name});
				if (FRdata.breeds[i].type === "M") {
					moderns.append(opt);
				}
				else {
					ancients.append(opt);
				}
			}
			elt.append(moderns, ancients);
		}
		
		// populate the colour dropdowns
		for (var elt of colourDropdowns){
			for (var i = 0; i < FRdata.colours.length; i++){
				const col = FRdata.colours[i];
				elt.add(Util.createElt("option", {
					value: i, text: col.name,
					style: `background:#${col.hex};color:${Util.textColourForBg(col.hex)}`
				}));
			}
		}
		
		// populate the gene dropdowns
		// TODO default val should be basic, except for hatchling, which has a default of Any
		// TODO maybe repopulate these + set to basic when the associated breed changes to one with diff available genes
		for (const slot of ["primary", "secondary", "tertiary"]){
			const dropdowns = Util.queryAll(`select.${slot}.gene`);
			for (var elt of dropdowns) {
				for (var i = 0; i < FRdata.genes[slot].length; i++){
					elt.add(
						Util.createElt("option", {value: i, text: FRdata.genes[slot][i].name})
					);
				}
			}
		}
		
		// set up event handlers
		Util.addEvt(calcBtn, "click", calcProbabilities);
	</script>
</body>
</html>