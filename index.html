<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>FR Hatchling Probability Calculator</title>
	<meta name="description" content="Flight Rising Breeding Probability Calculator">
	<meta name="author" content="Kaykao">

	<link rel="stylesheet" href="css/styles.css?v=0.1">
	
	<script type="text/javascript" src="app/fr_data.js"></script>
	<script type="text/javascript" src="app/utils.js"></script>
	<script type="text/javascript" src="app/calculator.js"></script>

</head>

<body>
	
	<br>
	
	
	<div id="parent1">
		<h2>Parent 1</h2>
		
		<div class="table">
		
			<div class="tr">
				<label for="p1-b">Breed:</label>
				<select class="breed" id="p1-b"></select>
			</div>
			
			<div class="tr">
				<span>Primary:</span>
				<label for="p1-c1" class="sr-only">Primary Colour</label>
				<select class="primary colour" id="p1-c1"></select>
				<label for="p1-g1" class="sr-only">Primary Gene</label>
				<select class="primary gene" id="p1-g1"></select>
			</div>
			
			<div class="tr">
				<span>Secondary:</span>
				<label for="p1-c2" class="sr-only">Secondary Colour</label>
				<select class="secondary colour" id="p1-c2"></select>
				<label for="p1-g2" class="sr-only">Secondary Gene</label>
				<select class="secondary gene" id="p1-g2"></select>
			</div>
			
			<div class="tr">
				<span>Tertiary:</span>
				<label for="p1-c3" class="sr-only">Tertiary Colour</label>
				<select class="tertiary colour" id="p1-c3"></select>
				<label for="p1-g3" class="sr-only">Tertiary Gene</label>
				<select class="tertiary gene" id="p1-g3"></select>
			</div>
			
		</div>
	</div>
	
	<div id="parent2">
		<h2>Parent 2</h2>
		
		<div class="table">
		
			<div class="tr">
				<label for="p2-b">Breed:</label>
				<select class="breed" id="p2-b"></select>
			</div>
			
			<div class="tr">
				<span>Primary:</span>
				<label for="p2-c1" class="sr-only">Primary Colour</label>
				<select class="primary colour" id="p2-c1"></select>
				<label for="p2-g1" class="sr-only">Primary Gene</label>
				<select class="primary gene" id="p2-g1"></select>
			</div>
			
			<div class="tr">
				<span>Secondary:</span>
				<label for="p2-c2" class="sr-only">Secondary Colour</label>
				<select class="secondary colour" id="p2-c2"></select>
				<label for="p2-g2" class="sr-only">Secondary Gene</label>
				<select class="secondary gene" id="p2-g2"></select>
			</div>
			
			<div class="tr">
				<span>Tertiary:</span>
				<label for="p2-c3" class="sr-only">Tertiary Colour</label>
				<select class="tertiary colour" id="p2-c3"></select>
				<label for="p2-g3" class="sr-only">Tertiary Gene</label>
				<select class="tertiary gene" id="p2-g3"></select>
			</div>
			
		</div>
	</div>

	<br>
	
	<div id="hatchling">
		<h2>Hatchling</h2>
		
		<div class="table">
		
			<div class="tr">
				<label for="h-b">Breed:</label>
				<select class="breed" id="h-b">
					<option value="any" selected="selected">Any</option>
				</select>
			</div>
			
			<div class="tr">
				<label for="h-e">Eye Type:</label>
				<select id="h-e">
					<option value="any" selected="selected">Any</option>
				</select>
			</div>
			
			<div class="tr">
				<label for="h-gen">Gender:</label>
				<select id="h-gen">
					<option value="any" selected="selected">Any</option>
					<option value="m">Male</option>
					<option value="f">Female</option>
				</select>
			</div>
			
			<div class="tr">
				<span>Primary:</span>
				<label for="h-c1" class="sr-only">Primary Colour</label>
				<select class="primary colour" id="h-c1">
					<option value="any" selected="selected">Any</option>
				</select>
				<label for="h-g1" class="sr-only">Primary Gene</label>
				<select class="primary gene" id="h-g1">
					<option value="any" selected="selected">Any</option>
				</select>
			</div>
			
			<div class="tr">
				<span>Secondary:</span>
				<label for="h-c2" class="sr-only">Secondary Colour</label>
				<select class="secondary colour" id="h-c2">
					<option value="any" selected="selected">Any</option>
				</select>
				<label for="h-g2" class="sr-only">Secondary Gene</label>
				<select class="secondary gene" id="h-g2">
					<option value="any" selected="selected">Any</option>
				</select>
			</div>
			
			<div class="tr">
				<span>Tertiary:</span>
				<label for="h-c3" class="sr-only">Tertiary Colour</label>
				<select class="tertiary colour" id="h-c3">
					<option value="any" selected="selected">Any</option>
				</select>
				<label for="h-g3" class="sr-only">Tertiary Gene</label>
				<select class="tertiary gene" id="h-g3">
					<option value="any" selected="selected">Any</option>
				</select>
			</div>
			
		</div>
		
		<!-- TODO colour ranges
		<div class="table">
			<div class="tr">
				<input type="radio" name="ranges" id="range-no" checked />
				<label>Specific Colours</label><br>
			</div>
			<div class="tr">
				<input type="radio" name="ranges" id="range-yes" />
				<label>Colour Ranges</label>
			</div>
		</div> -->
		
	</div>
	
	<br><br>
	
	<button type="button" id="calc">Calculate Probability</button>
	
	<br><br>
	
	<div id="results"></div>
	
	<!-- TODO add credits for where you got your dataaaaaaaa -->
	
	<script>
		const calcBtn = Util.get("calc");
		const resultElt = Util.get("results");
		const colourDropdowns = Util.getClz("colour");
		const breedDropdowns = Util.getClz("breed");
		const geneDropdowns = Util.getClz("gene");
		
		// populate the eye dropdown
		for (var i = 0; i < FRdata.eyes.length; i++){
			const opt = Util.createElt("option", {value: i, text: FRdata.eyes[i].name});
			Util.get("h-e").add(opt);
		}
		
		// populate the breed dropdowns
		for (var elt of breedDropdowns) {
			const moderns = Util.createElt("optgroup", {label: "Modern"}),
				ancients = Util.createElt("optgroup", {label: "Ancient"});
			
			for (var i = 0; i < FRdata.breeds.length; i++) {
				const opt = Util.createElt("option", {value: i, text: FRdata.breeds[i].name});
				if (FRdata.breeds[i].type === "M") {
					moderns.append(opt);
				}
				else {
					ancients.append(opt);
				}
			}
			elt.append(moderns, ancients);
		}
		
		// populate the colour dropdowns
		for (var elt of colourDropdowns){
			for (var i = 0; i < FRdata.colours.length; i++){
				const col = FRdata.colours[i];
				elt.add(Util.createElt("option", {
					value: i, text: col.name,
					style: `background:#${col.hex};color:${Util.textColourForBg(col.hex)}`
				}));
			}
		}
		
		// populate the gene dropdowns
		// TODO default val should be basic, except for hatchling, which has a default of Any
		// TODO maybe repopulate these + set to basic when the associated breed changes to one with diff available genes
		for (var slot of ["primary", "secondary", "tertiary"]){
			const dropdowns = Util.queryAll(`select.${slot}.gene`);
			for (var elt of dropdowns) {
				for (var i = 0; i < FRdata.genes[slot].length; i++){
					elt.add(
						Util.createElt("option", {value: i, text: FRdata.genes[slot][i].name})
					);
				}
			}
		}
		
		// Event handler for the "Calculate Probability" button
		function calcProbabilities(){
			//get params from page
			//TODO hatchling eyes
			var params = [];
			for (var x of ["p1", "p2", "h"]) {
				params.push({
					breed: Util.chosenOp(x+"-b").value,
					colours: {
						primary: Util.chosenOp(x+"-c1").value,
						secondary: Util.chosenOp(x+"-c2").value,
						tertiary: Util.chosenOp(x+"-c3").value,
					},
					genes: {
						primary: Util.chosenOp(x+"-g1").value,
						secondary: Util.chosenOp(x+"-g2").value,
						tertiary: Util.chosenOp(x+"-g3").value,
					}
				});
			}
			params[2].eye = Util.chosenOp("h-e").value;
			params[2].gender = Util.chosenOp("h-gen").value;
			
			//calculate probabilities
			const p = HatchCalc.hatchlingProbability({
				p1: params[0],
				p2: params[1],
				h: params[2],
			});
			
			// display the results
			if (p.err.length > 0){
				var str = "I have terrible news. There were errors in your input.<ul>";
				for (var e of p.err){
					str += `<li>${e}</li>`;
				}
				resultElt.innerHTML = str + "</ul>";
			} else {
				resultElt.innerHTML =
					`Breeding these parents will produce the Goal dragon ${(p.overall*100).toFixed(2)}% of the time, or 1 out of every ${(1/p.overall).toFixed(2)} eggs.<br><br>
					
					Each nest will have an average of ${p.avg_nest_size.toFixed(2)} eggs in it. This means each nest has a ${(p.per_nest*100).toFixed(2)}% chance of producing a Goal dragon, or 1 out of every ${(1/p.per_nest).toFixed(2)} nests.<br><br>
					
					Chance of hatching Goal within X number of eggs:<br>
					<table>
						<tr><th>Eggs</th><th>Chance</th></tr>
						${chanceTableToHtml(p.egg_table)}
					</table>
					
					Chance of hatching Goal within X number of nests:<br>
					<table>
						<tr><th>Nests</th><th>Chance</th></tr>
						${chanceTableToHtml(p.nest_table)}
					</table><br><br>
					
					The chances of hatching a dragon with X attribute matching the Goal is:<br>
					<table>
						<tr><th>Attribute</th><th>Chance</th></tr>
						<tr><td>Breed</td><td>${(p.breed*100).toFixed(2)}%</td></tr>
						<tr><td>Eye type</td><td>${(p.eye*100).toFixed(2)}%</td></tr>
						<tr><td>Colours</td><td>${(p.colour*100).toFixed(2)}%</td></tr>
						<tr><td>Genes</td><td>${(p.gene*100).toFixed(2)}%</td></tr>
					</table>`;
			}
				
		}
		
		// Turns a 2d array into rows for an HTML table
		function chanceTableToHtml(table) {
			var out = "";
			for (var i = 0; i < table.length; i++){
				if (table[i][1] >= 0.999){
					table[i][1] = "~100%";
				} else {
					table[i][1] = (table[i][1]*100).toFixed(2) + "%";
				}
				out += 
					`<tr>
						<td>${table[i][0]}</td>
						<td>${table[i][1]}</td>
					</tr>`;
			}
			return out;
		}
		
		// set up event handlers
		Util.addEvt(calcBtn, "click", calcProbabilities);
	</script>
</body>
</html>