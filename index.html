<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>FR Hatchling Probability Calculator</title>
	<meta name="description" content="Flight Rising Breeding Probability Calculator">
	<meta name="author" content="Kaykao">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="css/styles.css?v=0.2">
	<link rel="stylesheet" href="css/hatchcalc.css?v=0.2">

	<script type="text/javascript" src="js/fr_data.js"></script>
	<script type="text/javascript" src="js/utils.js"></script>
	<script type="text/javascript" src="js/hatchcalc.js"></script>

</head>

<body>

<header>
	<h1>FR Hatchling Probability Calculator</h1>
</header>

<main>

	<form>
		<h2>Input</h2>

		<fieldset id="parent1">
			<legend>Parent 1</legend>

			<label for="p1-b">Breed:</label>
			<select class="breed" id="p1-b"></select>

			<span>Primary:</span>
			<label for="p1-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="p1-c1"></select>
			<label for="p1-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="p1-g1"></select>

			<span>Secondary:</span>
			<label for="p1-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="p1-c2"></select>
			<label for="p1-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="p1-g2"></select>

			<span>Tertiary:</span>
			<label for="p1-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="p1-c3"></select>
			<label for="p1-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="p1-g3"></select>
		</fieldset>

		<fieldset id="parent2">
			<legend>Parent 2</legend>

			<label for="p2-b">Breed:</label>
			<select class="breed" id="p2-b"></select>

			<span>Primary:</span>
			<label for="p2-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="p2-c1"></select>
			<label for="p2-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="p2-g1"></select>

			<span>Secondary:</span>
			<label for="p2-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="p2-c2"></select>
			<label for="p2-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="p2-g2"></select>

			<span>Tertiary:</span>
			<label for="p2-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="p2-c3"></select>
			<label for="p2-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="p2-g3"></select>
		</fieldset>

		<fieldset id="hatchling">
			<legend>Hatchling</legend>

			<label for="h-b">Breed:</label>
			<select class="breed" id="h-b">
				<option value="any" selected="selected">Any</option>
			</select>

			<label for="h-e">Eye Type:</label>
			<select id="h-e" class="eye">
				<option value="any" selected="selected">Any</option>
			</select>

			<label for="h-gen">Gender:</label>
			<select id="h-gen" class="gender">
				<option value="any" selected="selected">Any</option>
				<option value="m">Male</option>
				<option value="f">Female</option>
			</select>

			<span>Primary:</span>
			<label for="h-c1" class="sr-only">Primary Colour</label>
			<select class="primary colour" id="h-c1">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g1" class="sr-only">Primary Gene</label>
			<select class="primary gene" id="h-g1">
				<option value="any" selected="selected">Any</option>
			</select>

			<span>Secondary:</span>
			<label for="h-c2" class="sr-only">Secondary Colour</label>
			<select class="secondary colour" id="h-c2">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g2" class="sr-only">Secondary Gene</label>
			<select class="secondary gene" id="h-g2">
				<option value="any" selected="selected">Any</option>
			</select>

			<span>Tertiary:</span>
			<label for="h-c3" class="sr-only">Tertiary Colour</label>
			<select class="tertiary colour" id="h-c3">
				<option value="any" selected="selected">Any</option>
			</select>
			<label for="h-g3" class="sr-only">Tertiary Gene</label>
			<select class="tertiary gene" id="h-g3">
				<option value="any" selected="selected">Any</option>
			</select>

			<!-- TODO colour ranges
			<input type="radio" name="ranges" id="range-no" checked />
			<label>Specific Colours</label><br>
			<input type="radio" name="ranges" id="range-yes" />
			<label>Colour Ranges</label>
			 -->

		</fieldset>

		<button type="button" id="calc">Calculate Probability</button>
	</form>

	<section >
		<h2>Results</h2>

		<div id="results">
			<div id="placeholder">
				<p>Enter the info for the parents and the desired hatchling, then click Calculate!</p>
			</div>
		</div>
	</section>

</main>


<footer>
	<span><a href="https://github.com/egad13/FR-Hatchling-Probability">Source code</a></span>
	|
	<span>Last updated: <time datetime="2023-07-30">30 July 2023</time></span>
</footer>

	<!-- TODO add credits for where you got your dataaaaaaaa -->

	<script id="window-onload">
		"use strict";
		const parent1 = collectDragonSelects("parent1"),
			parent2 = collectDragonSelects("parent2"),
			goal = collectDragonSelects("hatchling"),
			calcBtn = Util.get("calc"),
			resultElt = Util.get("results");

		//////// Event Handlers ////////

		// Calculate button
		Util.addEvt(calcBtn, "click", () => {
			const p = HatchCalc.getHatchlingReport(
				Util.mapObj(parent1, x => x.value),
				Util.mapObj(parent2, x => x.value),
				Util.mapObj(goal, x => x.value)
			);
			console.log(p);
			resultElt.innerHTML = HatchCalc.formatHatchlingReport(p);
		});

		// Breed dropdowns - changes contents of gene dropdowns
		(function() {
			// Previous breed selections; used to decide if genes need repopulating.
			var prevP1, prevP2, prevH;

			// Clears gene dropdowns associated with a breed dropdown, then
			// repopulates them with genes available to the newly chosen breed.
			function repopulateGenes(evt, prev) {
				const breed = evt.target.value;
				// If old and new breed are compatible, they have the same set of genes
				if (FRdata.areBreedsCompatible(breed, prev)) {
					return;
				}

				const setID = evt.target.closest("fieldset").id,
					isHatch = setID.includes("hatch"),
					removeUntil = isHatch ? 1 : 0;

				for (const slot of ["primary", "secondary", "tertiary"]) {
					var oldValFound = false;
					const dropdown = Util.query(`#${setID} select.${slot}.gene`),
						oldVal = (dropdown.value.length == 0 ? -1 : dropdown.value);
					// remove old options
					for(var i = dropdown.options.length-1; i >= removeUntil; i--) {
						dropdown.remove(i);
					}
					// add new ones. preserve previous selection if possible.
					if (isHatch) {
						dropdown.options[0].selected = true;
					}
					for (const gene of FRdata.genesForBreed(breed, slot)) {
						const attrs = {value: gene.index, text: gene.name};
						if (!oldValFound && attrs.value == oldVal) {
							oldValFound = true;
							attrs.selected = true;
						}
						if (!oldValFound && !isHatch && attrs.text === "Basic") {
							attrs.selected = true;
						}
						dropdown.add(Util.createElt("option", attrs));
					}
				}
			}

			Util.addEvt(parent1.breed, "focus", (evt) => {
				prevP1 = evt.target.value;
			});
			Util.addEvt(parent1.breed, "change", (evt) => {
				repopulateGenes(evt, prevP1);
				prevP1 = evt.target.value;
			});

			Util.addEvt(parent2.breed, "focus", (evt) => {
				prevP2 = evt.target.value;
			});
			Util.addEvt(parent2.breed, "change", (evt) => {
				repopulateGenes(evt, prevP2);
				prevP2 = evt.target.value;
			});

			Util.addEvt(goal.breed, "focus", (evt) => {
				prevH = evt.target.value;
			});
			Util.addEvt(goal.breed, "change", (evt) => {
				repopulateGenes(evt, prevH);
				prevH = evt.target.value;
			});
		})();


		//////// Populate Dropdowns ////////

		// populate the eye dropdown
		const eyes = Util.get("h-e");
		for (var i = 0; i < FRdata.eyes.length; i++){
			const opt = Util.createElt("option", {value: i, text: FRdata.eyes[i].name});
			eyes.add(opt);
		}

		// populate the breed dropdowns
		for (var elt of Util.getClz("breed")) {
			const moderns = Util.createElt("optgroup", {label: "Modern"}),
				ancients = Util.createElt("optgroup", {label: "Ancient"});

			for (var i = 0; i < FRdata.breeds.length; i++) {
				const opt = Util.createElt("option", {value: i, text: FRdata.breeds[i].name});
				if (FRdata.breeds[i].type === "M") {
					moderns.append(opt);
				}
				else {
					ancients.append(opt);
				}
			}
			elt.append(moderns, ancients);
		}

		// populate the colour dropdowns
		for (var elt of Util.getClz("colour")){
			for (var i = 0; i < FRdata.colours.length; i++){
				const col = FRdata.colours[i];
				elt.add(Util.createElt("option", {
					value: i, text: col.name,
					style: `background:#${col.hex};color:${Util.textColourForBg(col.hex)}`
				}));
			}
		}

		// populate the gene dropdowns
		Util.triggerEvt(parent1.breed, "change");
		Util.triggerEvt(parent2.breed, "change");
		Util.triggerEvt(goal.breed, "change");

		//////// Misc Functions ////////

		// Collects all the dropdown nodes for a dragon into one object for
		// easy manipulation and access
		function collectDragonSelects(id){
			var res = {
				breed: Util.query(`#${id} .breed`),
				colours: {
					primary: Util.query(`#${id} .primary.colour`),
					secondary: Util.query(`#${id} .secondary.colour`),
					tertiary: Util.query(`#${id} .tertiary.colour`)
				},
				genes: {
					primary: Util.query(`#${id} .primary.gene`),
					secondary: Util.query(`#${id} .secondary.gene`),
					tertiary: Util.query(`#${id} .tertiary.gene`)
				}
			};
			if (id === "hatchling") {
				res.eye = Util.query(`#${id} .eye`);
				res.gender = Util.query(`#${id} .gender`);
			}
			return res;
		}
	</script>

</body>
</html>
